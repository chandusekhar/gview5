@inherits BaseHandler
@inject IApplicationScope AppScope

<MudGrid Spacing="2" Justify="Justify.Center">
    <MudItem xs="12">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.h6">Coordinate System/Projection</MudText>
                @if (SpatialReference != null)
                {
                    <MudText Typo="Typo.body2">@SpatialReference.Name</MudText>
                    <MudText Typo="Typo.body2">@SpatialReference.Description</MudText>
                    <MudText Typo="Typo.caption">@String.Join(" ", SpatialReference.Parameters)</MudText>
                }
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Text" 
                            Color="Color.Primary"
                            OnClick="SelectProjection">Select</MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>
    @if (SpatialReference != null)
    {
        <MudItem xs="12">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Geodetic Datum</MudText>
                    @if (SpatialReference.Datum != null)
                    {
                        <MudText Typo="Typo.body2">@SpatialReference.Datum.Name</MudText>
                        <MudText Typo="Typo.caption">@SpatialReference.Datum.Parameter</MudText>
                    }
                </MudCardContent>
                @if (!EpsgOnly)
                {
                    <MudCardActions>
                        <MudButton Variant="Variant.Text"
                               Color="Color.Primary"
                               OnClick="SelectDatum">Select</MudButton>
                    </MudCardActions>
                }
            </MudCard>
        </MudItem>
    }
</MudGrid>

@code{
    [Parameter] public ISpatialReference? SpatialReference{ get; set; }
    [Parameter] public EventCallback<ISpatialReference> SRefChanged { get; set; }
    [Parameter] public bool EpsgOnly { get; set; } = false;

    private Task SelectProjection()
        => HandleAsync(async () =>
        {
            var model = await AppScope.ShowKnownDialog<BaseDialogModel<ISpatialReference>>(KnownDialogs.GeographicProjectionSelectorDialog);

            if (model?.Value != null)
            {
                this.SpatialReference = model?.Value;
                await SRefChanged.InvokeAsync(this.SpatialReference);
            }
        });

    private Task SelectDatum()
        => HandleAsync(async () =>
            {
                var model = await AppScope.ShowKnownDialog<BaseDialogModel<IGeodeticDatum>>(KnownDialogs.GeographicDatumSelectorDialog);

                if (model?.Value != null && this.SpatialReference is SpatialReference)
                {
                    ((SpatialReference)this.SpatialReference).Datum = model?.Value;
                    await SRefChanged.InvokeAsync(this.SpatialReference);
                }
            });
}
@inherits BaseHandler
@implements IDisposable

@inject IconService Icons
@inject ICartoApplicationService CartoApplication
@inject IApplicationScope AppScope
@inject PluginManagerService PluginManager
@inject CartoEventBusService EventBus

<MudTreeView  Items="TreeNodes"
              ExpandOnClick="true" 
              MultiSelection="false"
              Hover="true" Dense="true">
    <ItemTemplate>
        <div style="white-space:nowrap; overflow-x:hidden;"
             class="treenode">
            <MudTreeViewItem Value="@context"
                              Icon=@Icons.FromString(context.Icon)
                              Items="@context.Children"
                              CanExpand="@context.HasChildren"
                              Expanded="@context.IsExpanded"
                              ExpandedChanged="@((expanded) => OnNodeExpandedChanged(context, expanded))"
                              Text="@context.Text" 
                              @onclick="@(() => OnNodeClickAsync(context))">      
            </MudTreeViewItem>
        </div>
    </ItemTemplate>
</MudTreeView>

@code {
    private HashSet<TocTreeNode> TreeNodes { get; set; } = new HashSet<TocTreeNode>();

    async protected override Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        var tocMapNode = new TocMapNode((ICartoApplicationScopeService)AppScope);
        TreeNodes.Add(tocMapNode);
        await tocMapNode.Rebuild();

        EventBus.OnRefreshContentTreeAsync += RefreshContentTree;
    }

    private Task OnNodeExpandedChanged(TocTreeNode node, bool expanded) => base.HandleAsync(async () =>
    {
        node.IsExpanded = expanded;
    });

    private Task OnNodeClickAsync(TocTreeNode node) => base.HandleAsync(async () =>
    {
        await EventBus.FireSelectedTocTreeNodeChanged(node);
    });

    private Task RefreshContentTree()
        => this.InvokeAsync(() =>
        {
            StateHasChanged();
        });
   

    public void Dispose()
    {
        EventBus.OnRefreshContentTreeAsync -= RefreshContentTree;

        foreach(var treeNode in TreeNodes)
        {
            treeNode?.Dispose();
        }
    }
}
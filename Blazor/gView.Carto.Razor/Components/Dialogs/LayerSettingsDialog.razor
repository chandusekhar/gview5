@inherits ModalDialogFormBase<LayerSettingsModel>
@inject IconService IconService

@if (Model.Map is not null && Model.Layer is not null)
{
    <ModalDialogFormBase T="LayerSettingsModel"
                         OnDialogClose="base.OnDialogClose"
                         Model="base.Model">
        <DialogBody>
            <MudDrawerContainer Class="mud-height-full">
                <MudDrawer Variant="@DrawerVariant.Mini" Anchor="Anchor.Left"
                           Elevation="1"
                           @bind-Open="@_drawerIsOpen"
                           OpenMiniOnHover="true"
                           Fixed="false">
                    <MudList Clickable="true" @bind-SelectedValue="@_currentTab">
                        <MudListItem Icon="@IconService.FromString("basic:settings")" Style="white-space:nowrap"
                                     Value="Page.General" Text="Map / Display" />
                        <MudListItem Icon="@IconService.FromString("basic:copyright")" Style="white-space:nowrap"
                                     Value="Page.Description" Text="Description & (c)" />

                        @if(Model.Layer.ImplementsSpatialReference())
                        {
                            <MudListItem Icon="@IconService.FromString("basic:globe")" Style="white-space:nowrap"
                                         Value="Page.SpatialReference" Text="Spatial Reference" />
                        }
                        @if(Model.Layer is IGroupLayer) {
                            <MudListItem Icon="@IconService.FromString("basic:cloud-connect")" Style="white-space:nowrap"
                                         Value="Page.MapServiceBehavoir" Text="Map Service Behavoir" />
                        }

                        @if (Model.Layer.DatasetID >= 0)
                        {
                            <MudListItem Icon="@IconService.FromString("basic:database")" Style="white-space:nowrap"
                                         Value="Page.Source" Text="Source" />
                        }

                        @if (Model.Layer is IFeatureLayerComposition)
                        {
                            <MudListItem Icon="@IconService.FromString("webgis:layer-middle")" Style="white-space:nowrap"
                                         Value="Page.CompositionMode" Text="Composition Mode" />
                        }

                    </MudList>
                </MudDrawer>
            </MudDrawerContainer>

            <MudContainer Style="padding-left:50px;padding-right:10px">
                @if (Page.General.Equals(_currentTab))
                {
                    <LayerGeneralSettingsControl Layer="Model.Layer" />
                }
                else if (Page.Description.Equals(_currentTab))
                {
                    <LayerDescriptionControl Map="Model.Map" Layer="Model.Layer" />
                }
                else if (Page.MapServiceBehavoir.Equals(_currentTab))
                {
                    <GroupLayerMapServerBehavoirControl Layer="Model.Layer as IGroupLayer" />
                }
                else if(Page.Source.Equals(_currentTab))
                {
                    <LayerSourceControl Map="Model.Map" Layer="Model.Layer" />
                }
                else if(Page.CompositionMode.Equals(_currentTab))
                {
                    <LayerCompositionModeControl Layer="Model.Layer as IFeatureLayerComposition" />
                }
                else if(Page.SpatialReference.Equals(_currentTab))
                {
                    if(_sRef is not null)
                    {
                        <SpatialReferenceControl SpatialReference="_sRef" ReadOnly="true"/>
                    } 
                    else
                    {
                        @GvUtilities.InfoText("Spatial Reference System is not defined in this layer!");    
                    }
                }
            </MudContainer>
        </DialogBody>

        <DialogButtons>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Default"
                       OnClick="()=>base.Close()">Cancel</MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="Apply">Apply</MudButton>
        </DialogButtons>

    </ModalDialogFormBase>
}

@code
{
    private enum Page
    {
        General,
        Description,
        SpatialReference,
        MapServiceBehavoir,
        Source,
        CompositionMode
    }
    private bool _drawerIsOpen = false;
    private object _currentTab = Page.General;

    private ISpatialReference? _sRef;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        _sRef = Model.Layer?.GetSpatialReference();
    }

    protected Task Apply()
    {
        return base.Submit();
    }
}
@inherits BaseHandler
@implements IAsyncDisposable
@inject LeafletService Leaflet
@inject GeoTransformerService GeoTransformer
@inject MapRenderService MapRenderer

@if (LeafletMap != null)
{
    <LeafletMap Map="LeafletMap" />
}

@code {
    [Parameter] public IExplorerTabPage? FrameworkElement { get; set; }
    [Parameter] public IExplorerObject? CurrentExplorerObject { get; set; }

    private LMap? LeafletMap { get; set; }
    private ImageLayer? ImageLayer = null;

    private ISpatialReference _mapSRef = new SpatialReference("epsg:3857");

    protected override Task OnInitializedAsync()
        => HandleAsync(async () =>
        {
            await base.OnInitializedAsync();
            MapRenderer.OnRefreshMapImage += OnRefreshMapImage;
        });

    async protected override Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        await base.HandleAsync(async () =>
        {
            if (FrameworkElement == null)
            {
                return;
            }

            if (LeafletMap != null)
            {
                LeafletMap.OnIntialized -= OnMapInitialized;
                LeafletMap.OnViewReset -= OnMapViewRest;
                await LeafletMap.Destroy();
            }

            MapRenderer.InitMap(_mapSRef);
            MapRenderer.AddFeatureClass(await CurrentExplorerObject.GetInstanceAsync() as IFeatureClass);

            await FrameworkElement.SetExplorerObjectAsync(CurrentExplorerObject);
            LeafletMap = Leaflet.CreateMap();
            LeafletMap.OnIntialized += OnMapInitialized;

            //LeafletMap.OnViewReset += OnMapViewRest;
            LeafletMap.OnZoomEnd += OnMapViewRest;
            LeafletMap.OnMoveEnd += OnMapViewRest;
        });
    }

    private Task OnMapInitialized()
        => HandleAsync(async () => {
            IEnvelope? dataEnvelope = null;
            ISpatialReference? dataSRef = null;

            var exObject = FrameworkElement?.GetExplorerObject();
            if (exObject != null) 
            {
                var instance = await exObject.GetInstanceAsync();

                dataEnvelope = instance switch
                {
                    IFeatureClass fc => fc.Envelope,
                    IFeatureDataset ds => await ds.Envelope(),
                    _ => null
                };

                dataSRef = instance switch
                {
                    IFeatureClass fc => fc.SpatialReference,
                    IFeatureDataset ds => await ds.GetSpatialReference(),
                    _ => null
                };
            }
            await LeafletMap!.AddLayer(new gView.Razor.Leaflet.Models.Layers.TileLayer()
            {
                UrlTemplate = "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                Attribution = "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors",
                Opacity = 0.5
            });

            IEnvelope? lMapBounds = null;
            if (dataSRef != null && dataEnvelope != null)
            {
                lMapBounds = GeoTransformer.ToWGS84(new Envelope(dataEnvelope), dataSRef).Envelope;
            }

            if (lMapBounds != null)
            {
                LeafletMap.FitBounds(new LatLng(lMapBounds.LowerLeft.Y, lMapBounds.LowerLeft.X),
                                     new LatLng(lMapBounds.UpperRight.Y, lMapBounds.UpperRight.X));
            }
        });

    async private Task OnMapViewRest(object sender, Event e)
    {
        if (LeafletMap == null)
        {
            return;
        }

        var bounds = await LeafletMap.GetBounds();
        var size = await LeafletMap.GetImageSize();

        if (ImageLayer == null)
        {
            ImageLayer = new ImageLayer("", bounds.SouthWest, bounds.NorthEast) { Opacity = 0.8f };
            await LeafletMap.AddLayer(ImageLayer);
        }
        else
        {
            await LeafletMap.UpdateImageLayer(ImageLayer, "", bounds.SouthWest, bounds.NorthEast);
        }

        using (var mutex = await FuzzyMutexAsync.LockAsync(LeafletMap.Id))
        {
            if (mutex.WasBlocked == false)
            {
                await OnRefreshMapImage(null);

                await Task.Delay(300);

                var mapBounds = GeoTransformer.FromWGS84(new Envelope(bounds.SouthWest.Lng, bounds.SouthWest.Lat, bounds.NorthEast.Lng, bounds.NorthEast.Lat), _mapSRef).Envelope;
                MapRenderer.SetBoundsAndSize(mapBounds, size.Width, size.Height);
                MapRenderer.BeginRender();
            }
        }
    }

    async private Task OnRefreshMapImage(byte[]? data)
    {
        if (ImageLayer == null || LeafletMap == null)
        {
            return;
        }

        await LeafletMap.UpdateImageLayer(ImageLayer, $"data:image/png;base64, {Convert.ToBase64String(data ?? Array.Empty<byte>())}", null, null);
    }

    async public ValueTask DisposeAsync()
    {
        MapRenderer.OnRefreshMapImage -= OnRefreshMapImage;

        if (LeafletMap != null)
        {
            LeafletMap.OnIntialized -= OnMapInitialized;
            
            //LeafletMap.OnViewReset -= OnMapViewRest;
            LeafletMap.OnZoomEnd += OnMapViewRest;
            LeafletMap.OnMoveEnd += OnMapViewRest;

            await LeafletMap.Destroy();
        }
    }
}
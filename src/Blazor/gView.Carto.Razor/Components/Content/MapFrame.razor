@inherits BaseHandler
@implements IAsyncDisposable

@inject LeafletService Leaflet
@inject MapRenderService MapRenderer
@inject GeoTransformerService GeoTransformer
@inject ICartoApplicationScopeService AppScope
@inject CartoEventBusService EventBus
@inject MapControlBackgroundTilesService BackgroundTiles
@inject MapControlCrsService CrsService 

@if (_mapControl != null)
{
    <LeafletMap Map="_mapControl" Crs="_mapControlCrs" />
}

@code{
    private LMap? _mapControl;
    private LCrs? _mapControlCrs;
    private ImageLayer? _imageLayer = null;

    private ISpatialReference _mapControlSRef = new SpatialReference("epsg:3857");
    private bool _firstRendered = false;

    protected override Task OnInitializedAsync() => HandleAsync(async () =>
    {
        await base.OnInitializedAsync();

        EventBus.OnCartoDocumentLoadedAsync += OnCartoDocumentLoadedAsync;
        EventBus.OnRefreshMapAsync += OnRefreshMapAsync;
        EventBus.OnMapSettingsChangedAsync += OnMapSettingsChanged;
        EventBus.OnMapZoomToAsync += OnMapZoomToAsync;
        MapRenderer.OnRefreshMapImage += OnRefreshMapImage;

        await OnCartoDocumentLoadedAsync(AppScope.Document);
    });

    protected override Task OnAfterRenderAsync(bool firstRender) => HandleAsync(async () =>
    {
        await base.OnAfterRenderAsync(firstRender);

        if(firstRender)
        {
            _firstRendered = true;        
        }
    });


    private Task OnCartoDocumentLoadedAsync(ICartoDocument document) => HandleAsync(async () =>
    {
        bool reused = await CreateMapControl();

        if (document.Map is Map map)
        {
            // project map sref to current leaflet map transformation
            var mapBounds = GeoTransformer.Transform(map.Envelope, map.SpatialReference, _mapControlSRef).Envelope;
            //map.SpatialReference = _mapSRef;
            //map.Envelope = mapBounds;

            MapRenderer.InitMap(map, _mapControlSRef);

            if (reused && _mapControl is not null)
            {
                var boundsWgs84 = GeoTransformer.ToWGS84(new Envelope(mapBounds), _mapControlSRef).Envelope;

                await _mapControl.FitBounds(new LatLng(boundsWgs84.LowerLeft.Y, boundsWgs84.LowerLeft.X),
                                           new LatLng(boundsWgs84.UpperRight.Y, boundsWgs84.UpperRight.X));
            }
        }
    });

    private Task OnRefreshMapAsync(int delay) => HandleAsync(() =>
        MapRenderer.Rerender(delay));

    private Task OnMapSettingsChanged() => HandleAsync(() =>
        MapRenderer.Rerender(300));


    private Task OnMapZoomToAsync(IEnvelope zoomTo) => HandleAsync(async () =>
    {
        if(_mapControl is not null) 
        {
            var zoomToWgs84 = GeoTransformer.ToWGS84(zoomTo, _mapControlSRef).Envelope;

            await _mapControl.FitBounds(
                new LatLng(zoomToWgs84.LowerLeft.Y, zoomToWgs84.LowerLeft.X),
                new LatLng(zoomToWgs84.UpperRight.Y, zoomToWgs84.UpperRight.X));
        }
    });

    async private Task OnRefreshMapImage(byte[]? data)
    {
        if (_imageLayer is null || _mapControl is null)
        {
            return;
        }

        await _mapControl.UpdateImageLayer(_imageLayer, $"data:image/png;base64, {Convert.ToBase64String(data ?? Array.Empty<byte>())}", null, null);
    }

    async private Task OnMapViewRest(object sender, Event e)
    {
        if (_mapControl == null)
        {
            return;
        }

        using (var mutex = await FuzzyMutexAsync.LockAsync(_mapControl.Id))
        {
            if (mutex.WasBlocked == false)
            {
                await Task.Delay(300);

                var bounds = await _mapControl.GetBounds();
                var size = await _mapControl.GetImageSize();

                if (_imageLayer == null)
                {
                    _imageLayer = new ImageLayer("", bounds.SouthWest, bounds.NorthEast) { Opacity = 0.8f };
                    await _mapControl.AddLayer(_imageLayer);
                }
                else
                {
                    await _mapControl.UpdateImageLayer(_imageLayer, "", bounds.SouthWest, bounds.NorthEast);
                }

                await OnRefreshMapImage(null);

                var mapBounds = GeoTransformer.FromWGS84(new Envelope(bounds.SouthWest.Lng, bounds.SouthWest.Lat, bounds.NorthEast.Lng, bounds.NorthEast.Lat), _mapControlSRef).Envelope;
                MapRenderer.SetBoundsAndSize(mapBounds, size.Width, size.Height);
                MapRenderer.BeginRender();
            }
        }
    }

    async private Task OnMapClick(LMap sender, BlazorLeaflet.Models.Events.MouseEvent e)
    {

    }

    async private Task OnBBox(LMap sender, BlazorLeaflet.Models.Events.BBoxEvent e)
    {

    }

    #region Create/Intialize Map

    public Task<bool> CreateMapControl()
    {
        bool reused = true;

        if(_mapControlCrs is null)
        {
            var crsModel = CrsService.GetDefaultOrAny();
            _mapControlSRef = new SpatialReference($"epsg:{crsModel.Epsg}");

            _mapControlCrs = new LCrs()
            {
                Id = crsModel.Epsg,
                Proj4Parameters =
                    $"{String.Join(" ", _mapControlSRef.Parameters)} {_mapControlSRef.Datum?.Parameter}".Trim(),
                Origin = crsModel.Origin!,
                Resolutions = crsModel.Resolutions!,
                Bounds = crsModel.Bounds
            };
        }

        if (_mapControl is null)
        {
            _mapControl = Leaflet.CreateMap(_mapControl?.Id);
            _mapControl.OnIntialized += OnMapControlInitialized;

            //LeafletMap.OnViewReset += OnMapViewRest;
            _mapControl.OnZoomEnd += OnMapViewRest;
            _mapControl.OnMoveEnd += OnMapViewRest;

            _mapControl.OnClick += OnMapClick;
            _mapControl.OnBBox += OnBBox;

            reused = false;
        }

        //ImageLayer = null;

        return Task.FromResult(reused);
    }

    private Task OnMapControlInitialized() => HandleAsync(async () =>
    {
        var tiles = BackgroundTiles.GetDefaultOrAny();

        await _mapControl!.AddLayer(new gView.Razor.Leaflet.Models.Layers.TileLayer()
        {
            UrlTemplate = tiles.UrlTemplate,
            Attribution = tiles.Attribution,
            Opacity = Math.Max(tiles.Opacity, 0.1),
            MinimumZoom = tiles.MinZoom,
            MaximumZoom = tiles.MaxZoom > 0
                ? tiles.MaxZoom
                : _mapControlCrs?.Resolutions.Length - 1 ?? tiles.MaxNativeZoom,
            MaxNativeZoom = tiles.MaxNativeZoom,
            TileSize = tiles.TileSize?.Length == 2 && tiles.TileSize[0] > 0 && tiles.TileSize[1] > 0
                ? new gView.Razor.Leaflet.Models.Size(tiles.TileSize[0], tiles.TileSize[1])
                : new gView.Razor.Leaflet.Models.Size(256, 256)
        });

        var boundsWgs84 = _mapControlCrs?.Bounds?.Length == 4
                ? GeoTransformer.ToWGS84(
                                new Envelope(_mapControlCrs.Bounds[0], _mapControlCrs.Bounds[1],
                                             _mapControlCrs.Bounds[2], _mapControlCrs.Bounds[3]),
                                _mapControlSRef
                            ).Envelope
                : new Envelope(-180, -80, 180, 80);

        await _mapControl.FitBounds(new LatLng(boundsWgs84.LowerLeft.Y, boundsWgs84.LowerLeft.X),
                               new LatLng(boundsWgs84.UpperRight.Y, boundsWgs84.UpperRight.X));

    });

    #endregion

    #region Dispose / Destroy

    async public ValueTask DisposeAsync()
    {
        EventBus.OnCartoDocumentLoadedAsync -= OnCartoDocumentLoadedAsync;
        EventBus.OnRefreshMapAsync -= OnRefreshMapAsync;
        EventBus.OnMapSettingsChangedAsync -= OnMapSettingsChanged;
        EventBus.OnMapZoomToAsync -= OnMapZoomToAsync;
        MapRenderer.OnRefreshMapImage -= OnRefreshMapImage;

        await DestroyMapControl();
    }

    async public ValueTask DestroyMapControl()
    {
        if (_mapControl != null)
        {
            _mapControl.OnIntialized -= OnMapControlInitialized;

            //LeafletMap.OnViewReset -= OnMapViewRest;
            _mapControl.OnZoomEnd -= OnMapViewRest;
            _mapControl.OnMoveEnd -= OnMapViewRest;

            _mapControl.OnClick -= OnMapClick;
            _mapControl.OnBBox -= OnBBox;

            if (_firstRendered) {
                await _mapControl.Destroy();
            }

            _imageLayer = null;
        }
    }

    #endregion
}
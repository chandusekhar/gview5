window.gview||(window.gview={});window.gview.manage=function(){var o="/",c=function(n){o=n},n=function(n){$.ajax({url:o+n.url,type:n.type||"get",data:n.data||null,success:n.success||function(n){alert(n)},error:n.error||function(n,t,i){$(".loading").removeClass("loading");alert("Error: "+i+"("+t+")")}})},t=function(t,i){var r={},u;t.find(".form-value").length===0?r._emtpyform=!0:t.find(".form-value").each(function(n,t){r[$(t).attr("name")]=$(t).attr("type")==="checkbox"?$(t).prop("checked"):$(t).val()});i.type="post";i.data=r;u=i.success;i.success=function(n){t.find(".form-error").remove();n.success?u&&u(n):$("<div>").addClass("form-error").html(n.error).prependTo(t)};n(i)},i=function(n){var u=$("<div>").addClass("gview5-modal-blocker").appendTo($("body")).click(function(){$(this).find(".button-close").trigger("click")}),i=$("<div>").addClass("modal-dialog").appendTo(u).click(function(n){n.stopPropagation()}),t,r;if(n.title&&$("<div>"+n.title+"<\/div>").addClass("modal-title").appendTo(i),t=$("<div>").addClass("modal-body").appendTo(i),r=$("<div>").addClass("modal-footer").appendTo(i),$("<button>Close<\/button>").addClass("button-close").appendTo(r).click(function(i){if(i.stopPropagation(),n.onClose)n.onClose(t);$(this).closest(".gview5-modal-blocker").remove()}),n.onOk&&$("<button>OK<\/button>").addClass("button-ok").appendTo(r).click(function(i){if(i.stopPropagation(),n.onOk)n.onOk(t);$(this).closest(".gview5-modal-blocker").remove()}),n.onLoad)n.onLoad(t)},r=function(f,e){var o=f.children(".service[data-service='"+(e.folder?e.folder+"/":"")+e.name+"']"),s;return o.length===0&&(o=$("<li><\/li>").attr("data-service",(e.folder?e.folder+"/":"")+e.name).addClass("service").appendTo(f)),o.removeClass().addClass("service "+e.status).empty(),e.hasErrors&&o.addClass("has-errors"),s=$("<div>").addClass("toolbar").appendTo(o),$("<div>").addClass("icon clickable log").appendTo(s).click(function(){var t=$(this).closest(".service").attr("data-service"),r=function(i,u){i.empty();var f=$("<ul>").appendTo(i);$.each(u.errors,function(n,t){$("<li>").appendTo(f).html(t.replace(/(?:\r\n|\r|\n)/g,"<br>"))});u.ticks&&$("<button>older...<\/button>").appendTo(i).click(function(){n({url:"/manage/serviceerrorlogs?service="+t+"&last="+u.ticks,success:function(n){r(i,n)}})})};i({title:e.name+" (Error Logs)",onLoad:function(i){i.addClass("error-logs");n({url:"/manage/serviceerrorlogs?service="+t,success:function(n){r(i,n)}})}})}),$("<div>").addClass("icon clickable security"+(e.hasSecurity===!0?"1":"0")).appendTo(s).click(function(){var u=$(this).closest(".service").attr("data-service"),f=function(n,t,i){$("<td>✖<\/td>").addClass("remove").appendTo(n).click(function(){$(this).closest("tr").remove()});$("<td>").addClass("username").attr("data-username",i.username).html(i.username).appendTo(n);var r=!1;$.each(t,function(t,u){$cell=$("<td>").addClass("rule").appendTo(n);var f=$.inArray(u.toLowerCase(),i.servicetypes)>=0,e=$("<input type='checkbox' name='"+i.username+"~"+u+"' />").addClass("form-value").prop("checked",f).appendTo($cell);u.indexOf("_")===0&&(u==="_all"?(r=f,e.click(function(){var n=$(this).prop("checked");$(this).closest("tr").find("input.interpreter").css("display",n===!0?"none":"")})):e.addClass("interpreter").css("display",r===!0?"none":""))})},o=function(n,t){var r;n.empty();var u=$("<table>").appendTo(n),i=$("<tr>").appendTo(u),e=$("<th>").appendTo(i);$("<th>").html("User").appendTo(i);$.each(t.allTypes,function(n,t){var r=t;r.indexOf("_")===0&&(r="#"+r.substr(1).toUpperCase());$("<th>").addClass("rule").html(r).appendTo(i)});$.each(t.accessRules,function(n,r){i=$("<tr>").appendTo(u);f(i,t.allTypes,r)});i=$("<tr>").appendTo(u);$("<td>").appendTo(i);e=$("<td>").appendTo(i);r=$("<select>").appendTo(e);$("<option value=''><\/options>").appendTo(r);$("<option value='"+t.anonymousUsername+"'>"+t.anonymousUsername+"<\/option>").appendTo(r);$.each(t.allUsers,function(n,t){$("<option value='"+t+"'>").html(t).appendTo(r)});r.click(function(){if(val=$(this).val(),val&&$(this).closest("table").find(".username[data-username='"+val+"']").length===0){i=$("<tr>").insertBefore($(this).closest("tr"));var n=[];$.each(t.allTypes,function(t,i){(i.indexOf("_")!==0||i==="_all")&&n.push(i.toLowerCase())});f(i,t.allTypes,{username:val,servicetypes:n})}$(this).val("")})};i({title:e.name+" (Security)",onLoad:function(t){t.addClass("service-security");n({url:"/manage/servicesecurity?service="+u,success:function(n){o(t,n)}})},onOk:function(n){t(n,{url:"/manage/servicesecurity?service="+u,success:function(n){console.log(n);r($(".gview5-manage-body").find(".services"),n.service)}})}})}),$("<div>").addClass("icon clickable start "+(e.status==="running"?"gray":"")).appendTo(s).click(function(){u($(this).closest(".service"),"running")}),$("<div>").addClass("icon clickable stop "+(e.status==="stopped"?"gray":"")).appendTo(s).click(function(){u($(this).closest(".service"),"stopped")}),$("<div>").addClass("icon clickable refresh").appendTo(s).click(function(){u($(this).closest(".service"),"refresh")}),$("<h4>"+e.name+"<\/h4>").appendTo(o),e.runningSince&&$("<div>Running since: "+e.runningSince+"<\/div>").appendTo(o),o},s=function(t){var i=$(".services").empty();n({url:"/manage/services?folder="+t,success:function(n){$.each(n.services,function(n,t){r(i,t)})}})},l=function(){var r=$(".gview5-manage-body").empty().addClass("loading");n({url:"/manage/folders",success:function(u){var f,e;r.removeClass("loading");f=$("<ul>").addClass("folders").appendTo(r);$("<li>").addClass("folder selected").html("(root)").attr("data-folder","").appendTo(f);$.each(u.folders,function(r,u){if(u){var e=$("<li>").addClass("folder").html(u.name).attr("data-folder",u.name).appendTo(f),o=$("<div>").addClass("toolbar").appendTo(e);$("<div>").addClass("icon clickable security"+(u.hasSecurity===!0?"1":"0")).appendTo(o).click(function(r){r.stopPropagation();var f=function(n,t,i){$("<td>✖<\/td>").addClass("remove").appendTo(n).click(function(){$(this).closest("tr").remove()});$("<td>").addClass("username").attr("data-username",i.username).html(i.username).appendTo(n);var r=!1;$.each(t,function(t,u){$cell=$("<td>").addClass("rule").appendTo(n);var f=$.inArray(u.toLowerCase(),i.servicetypes)>=0,e=$("<input type='checkbox' name='"+i.username+"~"+u+"' />").addClass("form-value").prop("checked",f).appendTo($cell);u.indexOf("_")===0&&(u==="_all"?(r=f,e.click(function(){var n=$(this).prop("checked");$(this).closest("tr").find("input.interpreter").css("display",n===!0?"none":"")})):e.addClass("interpreter").css("display",r===!0?"none":""))})},e=function(n,t,i){var e,o,u;n.empty();var s=$("<table>").appendTo(n),r=$("<tr>").appendTo(s),h=$("<th>").appendTo(r);$("<th>").html("User").appendTo(r);$.each(t.allTypes,function(n,t){var i=t;i.indexOf("_")===0&&(i="#"+i.substr(1).toUpperCase());$("<th>").addClass("rule").html(i).appendTo(r)});$.each(t.accessRules,function(n,i){r=$("<tr>").appendTo(s);f(r,t.allTypes,i)});r=$("<tr>").appendTo(s);$("<td>").appendTo(r);h=$("<td>").appendTo(r);e=$("<select>").appendTo(h);$("<option value=''><\/options>").appendTo(e);$("<option value='"+t.anonymousUsername+"'>"+t.anonymousUsername+"<\/option>").appendTo(e);$.each(t.allUsers,function(n,t){$("<option value='"+t+"'>").html(t).appendTo(e)});e.click(function(){if(val=$(this).val(),val&&$(this).closest("table").find(".username[data-username='"+val+"']").length===0){r=$("<tr>").insertBefore($(this).closest("tr"));var n=[];$.each(t.allTypes,function(t,i){(i.indexOf("_")!==0||i==="_all")&&n.push(i.toLowerCase())});f(r,t.allTypes,{username:val,servicetypes:n})}$(this).val("")});i&&(o=$("<div>").addClass("section").appendTo(n),$("<h4>Folder Settings<\/h4>").appendTo(o),u=$("<div>").addClass("form-input").appendTo(o),$("<div>").addClass("label").text("Online Resource (override)").appendTo(u),$("<br>").appendTo(u),$("<input name='advancedsettings_onlineresource'>").addClass("form-value").val(t.onlineResource).appendTo(u),u=$("<div>").addClass("form-input").appendTo(o),$("<div>").addClass("label").text("Output Url (override)").appendTo(u),$("<br>").appendTo(u),$("<input name='advancedsettings_outputurl'>").addClass("form-value").val(t.outputUrl).appendTo(u))};i({title:u.name+" (Security)",onLoad:function(t){t.addClass("service-security");n({url:"/manage/foldersecurity?folder="+u.name,success:function(n){e(t,n,!0)}})},onOk:function(n){t(n,{url:"/manage/foldersecurity?folder="+u.name,success:function(n){if(n&&n.success&&n.folder){var t=$(".folders .folder[data-folder='"+n.folder.name+"']"),i="security"+(n.folder.hasSecurity===!0?"1":"0");t.find(".icon.clickable.security1").length>0?t.find(".icon.clickable.security1").removeClass("security1").addClass(i):t.find(".icon.clickable.security0").length>0&&t.find(".icon.clickable.security0").removeClass("security0").addClass(i)}}})}})})}});f.children(".folder").click(function(){$(this).parent().children(".folder").removeClass("selected");s($(this).addClass("selected").attr("data-folder"))});e=$("<ul>").addClass("services").appendTo(r);s("")}})},u=function(t,i){n({url:"/manage/setservicestatus?service="+t.attr("data-service")+"&status="+i,type:"post",success:function(n){r(t.closest(".services"),n.service)}})},f=function(n,t,i,r){var u=$("<div>").addClass("form-input").appendTo(n);$("<div>").addClass("label").html(r||t).appendTo(u);$("<br/>").appendTo(u);$("<input name='"+t+"' type='"+(i||"text")+"' autocomplete='off' />").addClass("form-value").appendTo(u)},a=function(n,t,i){$("<input type='hidden' name='"+t+"' />").val(i).addClass("form-value").appendTo(n)},h=function(n){var r=$(".user-properties").empty(),i=$("<div>").addClass("form").appendTo(r);n===""?(f(i,"NewUsername"),f(i,"NewPassword","password"),$("<button>Create<\/button>").appendTo(i).click(function(){t(i,{url:"/manage/createtokenuser",success:function(){e()}})})):(a(i,"Username",n),f(i,"NewPassword","password","New password"),$("<button>Change<\/button>").appendTo(i).click(function(){t(i,{url:"/manage/changetokenuserpassword",success:function(){e()}})}))},e=function(){var t=$(".gview5-manage-body").empty().addClass("loading");n({url:"/manage/tokenusers",success:function(n){var i=$("<ul>").addClass("users").appendTo(t);$("<li>New...<\/li>").addClass("user new selected").appendTo(i).click(function(){$(this).parent().children(".user").removeClass("selected");$(this).addClass("selected");h("")});$.each(n.users,function(n,t){$("<li>").addClass("user").attr("data-user",t).html(t).appendTo(i).click(function(){$(this).parent().children(".user").removeClass("selected");$(this).addClass("selected");h($(this).attr("data-user"))})});$("<div>").addClass("user-properties").appendTo(t);i.children(".user.new").trigger("click")}})};return{pageServices:l,pageSecurity:e,setRootUrl:c}}();